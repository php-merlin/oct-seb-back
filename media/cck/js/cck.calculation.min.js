/*
 * jQuery Calculation Plug-in * Copyright (c) 2011 Dan G. Switzer, II Dual licensed under the MIT and GPL licenses: * http://www.opensource.org/licenses/mit-license.php * http://www.gnu.org/licenses/gpl.html
 * Modified for SEBLOD (App Builder & CCK) // SEBLOD nano (Form Builder).
 */
!function($){var defaults={formatNumber:0,sepDecimals:".",sepThousands:",",reChars:/([a-zA-Z0-9\ \-\_\.\:\/])*/g,reNumbers:/(-?\$?)(\d+(,\d{3})*(\.\d{1,})?|\.\d{1,})/g,cleanseNumber:function(e){return e.replace(/[^0-9.\-]/g,"")},useFieldPlugin:!!$.fn.getValue,onParseError:null,onParseClear:null};$.Calculation={version:"0.4.09",setDefaults:function(e){$.extend(defaults,e)}},$.fn.parseChar=function(s,n){var l=[];return n=$.extend(n,defaults),this.each(function(e){if(s[e]){if((r=$(this)).is("select"))var t=$.trim(r.find("option:selected").attr(s[e])).match(defaults.reChars,"");else if(r.is("fieldset"))t=$.trim(r.find("input:checked").attr(s[e])).match(defaults.reChars,"");else t=$.trim(r.attr(s[e])).match(defaults.reChars,"");t=null==t?"":t.toString().replace(",","")}else{var r,a=(r=$(this)).is(":input")?defaults.useFieldPlugin?"getValue":"val":r.is("fieldset")?"myVal":"text";null==(t=$.trim(r[a]()).match(defaults.reChars,""))?(t="",jQuery.isFunction(n.onParseError)&&n.onParseError.apply(r,[a]),$.data(r[0],"calcParseError",!0)):(t=t[0],$.data(r[0],"calcParseError")&&jQuery.isFunction(n.onParseClear)&&(n.onParseClear.apply(r,[a]),$.data(r[0],"calcParseError",!1)))}l.push(t)}),l},$.fn.parseNumber=function(i,u){var o=[];return u=$.extend(u,defaults),this.each(function(e){if(i[e]){if((a=$(this)).is("select"))var t=$.trim(a.find("option:selected").attr(i[e])).match(defaults.reNumbers,"");else if(a.is("fieldset")){t=0;var r=0;a.find("input:checked").each(function(){(r=$(this).attr(i[e]))&&(t+=parseInt(r))}),t=$.trim(t).match(defaults.reNumbers,"")}else t=$.trim(a.attr(i[e])).match(defaults.reNumbers,"");null==t&&(t=0)}else{var a;if((a=$(this)).is("fieldset")){if(sMethod="myVal",t=a[sMethod]()){var s=t.split(","),n=s.length;if(1<n)for(var l=t=0;l<n;l++)s[l]&&(t+=parseInt(s[l]))}t=$.trim(t).match(defaults.reNumbers,"")}else if(a.is(":input")){sMethod=defaults.useFieldPlugin?"getValue":"val";t=$.trim(a[sMethod]()).match(defaults.reNumbers,"")}else{sMethod="text";t=$.trim(a[sMethod]()).match(defaults.reNumbers,"")}null==t?(t=0,jQuery.isFunction(u.onParseError)&&u.onParseError.apply(a,[sMethod]),$.data(a[0],"calcParseError",!0)):(t=u.cleanseNumber.apply(this,[t[0]]),$.data(a[0],"calcParseError")&&jQuery.isFunction(u.onParseClear)&&(u.onParseClear.apply(a,[sMethod]),$.data(a[0],"calcParseError",!1)))}o.push(parseFloat(t,10))}),o},$.fn.calc=function(expr,vars,targets,cbFormat,cbDone){var $this=this,exprValue="",precision=0,$el,$el2,parsedVars={},tmp,sMethod,target=[],_,bIsError=!1,i=0;for(var k in vars)expr=expr.replace(new RegExp("("+k+")","g"),"_.$1"),vars[k]&&vars[k].jquery?(target[0]=targets[i],parsedVars[k]=vars[k].parseNumber(target)):parsedVars[k]=vars[k],i++;return this.each(function(i,el,el2){var p,len,v;for(var k in $el=$(this),$el2=$("#_"+$(this).attr("id")),sMethod=$el.is(":input")?defaults.useFieldPlugin?"setValue":"val":$el.is("fieldset")?"myVal":"text",_={},parsedVars)"number"==typeof parsedVars[k]?_[k]=parsedVars[k]:"string"==typeof parsedVars[k]?_[k]=parseFloat(parsedVars[k],10):parsedVars[k]&&parsedVars[k]instanceof Array&&(tmp=parsedVars[k].length==$this.length?i:0,_[k]=parsedVars[k][tmp]),isNaN(_[k])&&(_[k]=0),p=_[k].toString().match(/\.\d+$/gi),len=p?p[0].length-1:0,precision<len&&(precision=len);try{if(exprValue=eval(expr),precision&&(exprValue=Number(exprValue.toFixed(Math.max(precision,4)))),jQuery.isFunction(cbFormat)){var tmp=cbFormat.apply(this,[exprValue]);tmp&&(exprValue=tmp)}}catch(e){exprValue=e,bIsError=!0}v=exprValue.toString(),defaults.formatNumber&&(v=formatNumber(v,defaults.sepDecimals,defaults.sepThousands)),$el[sMethod](v),$el2.length&&(sMethod=$el2.is(":input")?defaults.useFieldPlugin?"setValue":"val":"text",$el2[sMethod](v))}),jQuery.isFunction(cbDone)&&cbDone.apply(this,[this]),this},$.each(["sum","product","concatenate","avg","count","max","min"],function(e,o){$.fn[o]=function(e,t,r){r=r||[];if(0==arguments.length)return math[o](this.parseNumber());var a=t&&t.constructor==Object&&!(t instanceof jQuery),s=e&&e.constructor==Object?e:{bind:e||"keyup",selector:a?null:t,selector2:"",oncalc:null};a&&(s=jQuery.extend(s,t)),s.selector&&(s.selector=$(s.selector)),s.selector2=$("#_"+s.selector.attr("id"));function n(){var e=math[o](u[i](r,s)),t=e.toString();defaults.formatNumber&&(t=formatNumber(t,defaults.sepDecimals,defaults.sepThousands)),s.selector&&(l=s.selector.is(":input")?defaults.useFieldPlugin?"setValue":"val":"text",s.selector[l](t)),s.selector2.length&&(l=s.selector2.is(":input")?defaults.useFieldPlugin?"setValue":"val":"text",s.selector2[l](t)),jQuery.isFunction(s.oncalc)&&s.oncalc.apply(u,[e,s])}var l,i="concatenate"==o?"parseChar":"parseNumber",u=this;return n(),"none"!=s.bind?u.bind(s.bind,n):void 0}});var math={sum:function(e){var s=0,n=0;return $.each(e,function(e,t){var r=t.toString().match(/\.\d+$/gi),a=r?r[0].length-1:0;n<a&&(n=a),s+=t}),n&&(s=Number(s.toFixed(n))),s},product:function(e){var s=1,n=0;return $.each(e,function(e,t){var r=t.toString().match(/\.\d+$/gi),a=r?r[0].length-1:0;n<a&&(n=a),s*=t}),n&&(s=Number(s.toFixed(n))),s},concatenate:function(e){var r="";return $.each(e,function(e,t){r+=t}),r},avg:function(e){return math.sum(e)/e.length},count:function(e){return e.length},max:function(e){return Math.max.apply(Math,e)},min:function(e){return Math.min.apply(Math,e)}};$.fn.format=function(e,t,r){r=r||[];if(0==arguments.length)return this.val();var a=t&&t.constructor==Object&&!(t instanceof jQuery),s=e&&e.constructor==Object?e:{bind:e||"keyup",selector:a?null:t,selector2:"",oncalc:null};a&&(s=jQuery.extend(s,t)),s.selector&&(s.selector=$(s.selector)),s.selector2=$("#_"+s.selector.attr("id"));function n(){if(""!=defaults.sepThousands)var e=new RegExp("\\"+defaults.sepThousands,"g"),t=s.selector.val().replace(e,"");else t=s.selector.val();var r=formatNumber(t.toString(),defaults.sepDecimals,defaults.sepThousands);s.selector&&s.selector.val(r),s.selector2.length&&s.selector2.val(r),jQuery.isFunction(s.oncalc)&&s.oncalc.apply(l,[t,s])}var l=this;return n(),"none"!=s.bind?l.bind(s.bind,n):void 0};var formatNumber=function(e,t,r){if(x=(e+="").split("."),x1=x[0],x2=1<x.length?t+x[1]:"",""!=r)for(var a=/(\d+)(\d{3})/;a.test(x1);)x1=x1.replace(a,"$1"+r+"$2");return x1+x2}}(jQuery);